{"version":3,"file":"StackstormClient.esm.js","sources":["../../src/api/StackstormClient.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Action, Execution, Pack, StackstormApi } from './types';\nimport { ConfigApi, DiscoveryApi, FetchApi } from '@backstage/core-plugin-api';\nimport { ResponseError } from '@backstage/errors';\n\nexport class StackstormClient implements StackstormApi {\n  private readonly discoveryApi: DiscoveryApi;\n  private readonly fetchApi: FetchApi;\n  private readonly webUrl: string;\n\n  private constructor({\n    discoveryApi,\n    fetchApi,\n    webUrl,\n  }: {\n    discoveryApi: DiscoveryApi;\n    fetchApi: FetchApi;\n    webUrl: string;\n  }) {\n    this.discoveryApi = discoveryApi;\n    this.fetchApi = fetchApi;\n    this.webUrl = webUrl;\n  }\n\n  static fromConfig(\n    config: ConfigApi,\n    dependencies: {\n      discoveryApi: DiscoveryApi;\n      fetchApi: FetchApi;\n    },\n  ): StackstormClient {\n    return new StackstormClient({\n      discoveryApi: dependencies.discoveryApi,\n      fetchApi: dependencies.fetchApi,\n      webUrl: config.getString('stackstorm.webUrl'),\n    });\n  }\n\n  private async get<T = any>(input: string): Promise<T> {\n    const apiUrl = `${await this.discoveryApi.getBaseUrl('proxy')}/stackstorm`;\n    const response = await this.fetchApi.fetch(`${apiUrl}${input}`, {\n      headers: {\n        'Content-Type': 'application/json',\n      },\n    });\n\n    if (!response.ok) throw await ResponseError.fromResponse(response);\n    return (await response.json()) as T;\n  }\n\n  async getExecutions(limit?: number, offset?: number): Promise<Execution[]> {\n    const params = {\n      limit: limit?.toString() || '10',\n      offset: offset?.toString() || '0',\n      include_attributes:\n        'id,status,start_timestamp,action.ref,action.name,rule.ref',\n      parent: 'null',\n    };\n    const path = `/executions?${new URLSearchParams(params)}`;\n    return this.get<Execution[]>(path);\n  }\n\n  async getExecution(id: string): Promise<Execution> {\n    const path = `/executions/${encodeURIComponent(id)}`;\n    return this.get<Execution>(path);\n  }\n\n  async getPacks(): Promise<Pack[]> {\n    return this.get<Pack[]>('/packs');\n  }\n\n  async getActions(pack: string): Promise<Action[]> {\n    const params = {\n      include_attributes: 'id,ref,name,pack,description,runner_type',\n      pack: pack,\n    };\n    const path = `/actions?${new URLSearchParams(params)}`;\n    return this.get<Action[]>(path);\n  }\n\n  getExecutionHistoryUrl(id: string): string {\n    return `${this.webUrl}/?#/history/${encodeURIComponent(id)}`;\n  }\n\n  getActionUrl(ref: string): string {\n    return `${this.webUrl}/?#/actions/${encodeURIComponent(ref)}`;\n  }\n}\n"],"names":[],"mappings":"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"}