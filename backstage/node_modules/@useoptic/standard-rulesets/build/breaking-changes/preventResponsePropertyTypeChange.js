"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.preventResponsePropertyTypeChange = void 0;
const rulesets_base_1 = require("@useoptic/rulesets-base");
const type_change_1 = require("./helpers/type-change");
const unions_1 = require("./helpers/unions");
const preventResponsePropertyTypeChange = () => new rulesets_base_1.ResponseBodyRule({
    name: 'prevent response property type changes',
    rule: (responseAssertions) => {
        responseAssertions.body.changed((before, after) => {
            // Children of union properties / transitions are handled in a separate rule
            if ((0, unions_1.schemaIsUnion)(before.value.flatSchema) ||
                (0, unions_1.schemaIsUnion)(after.value.flatSchema)) {
                return;
            }
            if ((0, type_change_1.computeEffectiveTypeChange)(before.value.flatSchema.type, after.value.flatSchema.type).expanded) {
                throw new rulesets_base_1.RuleError({
                    message: `expected response body ${after.value.contentType} root shape not to be expanded. This is a breaking change.`,
                });
            }
        });
        responseAssertions.property.changed((before, after) => {
            // Children of union properties / transitions are handled in a separate rule
            if ((0, unions_1.schemaIsUnion)(before.value.flatSchema) ||
                (0, unions_1.isInUnionProperty)(before.location.jsonPath) ||
                (0, unions_1.schemaIsUnion)(after.value.flatSchema) ||
                (0, unions_1.isInUnionProperty)(after.location.jsonPath)) {
                return;
            }
            if ((0, type_change_1.computeEffectiveTypeChange)(before.value.flatSchema.type, after.value.flatSchema.type).expanded) {
                throw new rulesets_base_1.RuleError({
                    message: `expected response body property '${after.value.key}' not to be expanded. This is a breaking change.`,
                });
            }
        });
    },
});
exports.preventResponsePropertyTypeChange = preventResponsePropertyTypeChange;
//# sourceMappingURL=preventResponsePropertyTypeChange.js.map