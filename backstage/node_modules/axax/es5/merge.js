"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var subject_1 = require("./subject");
var toCallbacks_1 = require("./toCallbacks");
/**
 * Merges iterables
 *
 * @param sources the iterables to merge
 */
function merge() {
    var sources = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        sources[_i] = arguments[_i];
    }
    var subject = new subject_1.Subject();
    var done = false;
    subject.finally(function () {
        done = true;
    });
    var doneCount = 0;
    sources.map(function (source) {
        return toCallbacks_1.toCallbacks(function (result) {
            if (result.done) {
                doneCount += 1;
                if (doneCount >= sources.length) {
                    done = true;
                    return subject.callback(result);
                }
            }
            if (done) {
                throw new toCallbacks_1.StopError();
            }
            else if (!result.done) {
                return subject.callback(result);
            }
            else {
                return Promise.resolve();
            }
        })(source);
    });
    return subject.iterator;
}
exports.merge = merge;
